name: PR Review Notification

on:
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [synchronize]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Send Discord notification
        uses: actions/github-script@v7
        with:
          script: |
            const review = context.payload.review;
            const pr = context.payload.pull_request;
            
            // Get GitHub to Discord ID mapping from secrets
            let idMapping = {};
            let authorReviewerMapping = {};
            
            console.log('USERNAME_DISCORD_MAPPING:', process.env.USERNAME_DISCORD_MAPPING);
            try {
              if (!process.env.USERNAME_DISCORD_MAPPING) {
                throw new Error('USERNAME_DISCORD_MAPPING ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
              // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë§¤í•‘ ë¬¸ìì—´ì„ íŒŒì‹±
              const mappings = process.env.USERNAME_DISCORD_MAPPING.split(',');
              for (const mapping of mappings) {
                const [githubUsername, discordId] = mapping.split(':').map(s => s.trim());
                if (githubUsername && discordId) {
                  idMapping[githubUsername] = discordId;
                }
              }
              if (Object.keys(idMapping).length === 0) {
                throw new Error('USERNAME_DISCORD_MAPPINGì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
              }
            } catch (error) {
              console.error('ì‹œí¬ë¦¿ íŒŒì‹± ì—ëŸ¬:', error.message);
              throw new Error(`ì‹œí¬ë¦¿ íŒŒì‹± ì—ëŸ¬: ${error.message}`);
            }
            
            console.log('AUTHOR_REVIEWER_MAPPING:', process.env.AUTHOR_REVIEWER_MAPPING);
            try {
              if (!process.env.AUTHOR_REVIEWER_MAPPING) {
                throw new Error('AUTHOR_REVIEWER_MAPPING ì‹œí¬ë¦¿ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
              }
              // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë§¤í•‘ ë¬¸ìì—´ì„ íŒŒì‹±
              const mappings = process.env.AUTHOR_REVIEWER_MAPPING.split(',');
              for (const mapping of mappings) {
                const [author, reviewer] = mapping.split(':').map(s => s.trim());
                if (author && reviewer) {
                  authorReviewerMapping[author] = reviewer;
                }
              }
              if (Object.keys(authorReviewerMapping).length === 0) {
                throw new Error('AUTHOR_REVIEWER_MAPPINGì´ ì˜¬ë°”ë¥¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
              }
            } catch (error) {
              console.error('ì‹œí¬ë¦¿ íŒŒì‹± ì—ëŸ¬:', error.message);
              throw new Error(`ì‹œí¬ë¦¿ íŒŒì‹± ì—ëŸ¬: ${error.message}`);
            }
            
            // Get Discord IDs
            const assigneeDiscordId = idMapping[pr.assignee?.login] || pr.assignee?.login;
            const reviewerDiscordId = idMapping[review.user.login] || review.user.login;
            
            const assigneeMention = assigneeDiscordId ? `<@${assigneeDiscordId}>` : 'PR ì‘ì„±ì';
            const reviewerMention = `<@${reviewerDiscordId}>`;
            
            // ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€
            const stateEmoji = {
              APPROVED: 'âœ…',
              CHANGES_REQUESTED: 'âŒ',
              COMMENTED: 'ğŸ’¬'
            };
            
            const message = {
              embeds: [{
                title: `PR ë¦¬ë·° ì•Œë¦¼ ${stateEmoji[review.state]}`,
                url: review.html_url,
                color: review.state === 'APPROVED' ? 0x57F287 : 
                       review.state === 'CHANGES_REQUESTED' ? 0xED4245 : 0x5865F2,
                fields: [
                  {
                    name: 'ë¦¬ë·° ìƒíƒœ',
                    value: review.state === 'APPROVED' ? 'ìŠ¹ì¸' :
                           review.state === 'CHANGES_REQUESTED' ? 'ë³€ê²½ ìš”ì²­' : 'ì½”ë©˜íŠ¸'
                  },
                  {
                    name: 'ë¦¬ë·° ë‚´ìš©',
                    value: review.body || 'ë¦¬ë·° ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'
                  }
                ],
                description: `${assigneeMention}ë‹˜ ${reviewerMention}ë‹˜ì˜ ë¦¬ë·°ê°€ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`
              }]
            };
            
            await fetch(process.env.DISCORD_WEBHOOK_URL, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(message),
            });
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          USERNAME_DISCORD_MAPPING: ${{ secrets.USERNAME_DISCORD_MAPPING }}
          AUTHOR_REVIEWER_MAPPING: ${{ secrets.AUTHOR_REVIEWER_MAPPING }} 